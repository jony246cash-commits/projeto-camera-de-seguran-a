<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Lite - Transmiss√£o Direta</title>
    
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #0a0a0a; color: #fff; text-align: center; }
        .status-badge { padding: 12px; background: #111; font-size: 13px; border-bottom: 2px solid #333; color: #3b82f6; }
        .painel { padding: 30px 20px; }
        button { width: 85%; max-width: 300px; padding: 18px; margin: 8px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-cam { background: #059669; color: white; }
        .btn-mon { background: #2563eb; color: white; }
        
        .camera-card { background: #1a1a1a; margin: 15px auto; padding: 15px; width: 90%; max-width: 450px; border-radius: 12px; border: 1px solid #333; text-align: left; }
        .video-wrapper { width: 100%; border-radius: 8px; overflow: hidden; background: #000; margin-top: 10px; }
        video { width: 100%; display: block; }

        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 15px; }
        .prova-item { background: #222; padding: 8px; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>

    <div id="status" class="status-badge">üîµ Sistema de Transmiss√£o Pronto</div>

    <div id="menu-inicial" class="painel">
        <h1>üõ°Ô∏è Smart Guard Lite</h1>
        <p>Transmiss√£o Cont√≠nua & Grava√ß√£o 24h</p>
        <button id="btnCam" class="btn-cam">MODO C√ÇMERA (Transmitir)</button><br>
        <button id="btnMon" class="btn-mon">MODO MONITOR (Visualizar)</button>
    </div>

    <div id="tela-camera" style="display:none;">
        <h3 id="cam-id-txt">C√¢mera Ativa</h3>
        <video id="webcam" autoplay muted playsinline style="width: 80%; border-radius: 10px;"></video>
        <p>üì° Transmitindo e gravando em blocos de 2 min...</p>
    </div>

    <div id="tela-monitor" style="display:none;">
        <h3>Central de Monitoramento</h3>
        <input type="text" id="id-nova-camera" placeholder="ID da C√¢mera" style="padding:12px; border-radius:8px; border:none; width:150px;">
        <button id="btnAdd" style="width:auto; padding:12px;" class="btn-mon">VER</button>
        
        <div id="lista-cameras"></div>
        
        <h4>üé• Grava√ß√µes Recentes (Auto-limpeza 24h)</h4>
        <div id="galeria-provas" class="galeria"></div>
    </div>

    <script>
        let peer, localStream, mediaRecorder;
        let chunks = [];
        let conexoes = {};
        const TEMPO_GRAVACAO = 120000; // 2 minutos em milissegundos

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            document.getElementById('btnCam').onclick = modoCamera;
            document.getElementById('btnMon').onclick = modoMonitor;
            // Limpa grava√ß√µes velhas ao abrir
            limparGravacoesAntigas();
        };

        // --- L√ìGICA DA C√ÇMERA ---
        async function modoCamera() {
            const id = prompt("Nome desta c√¢mera:");
            if (!id) return;

            localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
            document.getElementById('webcam').srcObject = localStream;
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('tela-camera').style.display = 'block';
            document.getElementById('cam-id-txt').innerText = "üé• C√¢mera: " + id;

            peer = new Peer(id, { config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });
            
            peer.on('connection', conn => {
                conexoes[conn.peer] = conn;
                // Envia o stream imediatamente ao conectar
                peer.call(conn.peer, localStream);
            });

            iniciarLoopGravacao();
        }

        function iniciarLoopGravacao() {
            mediaRecorder = new MediaRecorder(localStream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = salvarEEnviarBloco;
            
            mediaRecorder.start();
            console.log("Iniciando bloco de 2 minutos...");

            setTimeout(() => {
                mediaRecorder.stop();
                iniciarLoopGravacao(); // Reinicia o ciclo
            }, TEMPO_GRAVACAO);
        }

        function salvarEEnviarBloco() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                Object.values(conexoes).forEach(conn => {
                    conn.send({ tipo: 'arquivo', data: reader.result, de: peer.id, timestamp: Date.now() });
                });
                chunks = [];
            };
        }

        // --- L√ìGICA DO MONITOR ---
        function modoMonitor() {
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('tela-monitor').style.display = 'block';
            peer = new Peer();

            document.getElementById('btnAdd').onclick = () => {
                const id = document.getElementById('id-nova-camera').value;
                const conn = peer.connect(id);
                
                conn.on('open', () => {
                    if (!document.getElementById('card-'+id)) criarCard(id);
                });

                conn.on('data', msg => {
                    if (msg.tipo === 'arquivo') {
                        adicionarGaleria(msg.data, msg.de, msg.timestamp);
                    }
                });
            };

            peer.on('call', call => {
                call.answer();
                call.on('stream', st => {
                    const vid = document.querySelector(`#vid-${call.peer}`);
                    if (vid) vid.srcObject = st;
                });
            });
        }

        function criarCard(id) {
            const div = document.createElement('div');
            div.id = 'card-'+id;
            div.className = 'camera-card';
            div.innerHTML = `
                <b>üìç ${id}</b> (Ao Vivo)
                <div class="video-wrapper"><video id="vid-${id}" autoplay muted playsinline></video></div>
            `;
            document.getElementById('lista-cameras').appendChild(div);
        }

        function adicionarGaleria(url, de, time) {
            // Salva no localStorage para persistir por 24h
            const gravacoes = JSON.parse(localStorage.getItem('vigilancia_vids') || '[]');
            gravacoes.push({ url, de, time });
            localStorage.setItem('vigilancia_vids', JSON.stringify(gravacoes));
            
            renderizarGaleria();
        }

        function renderizarGaleria() {
            const lista = document.getElementById('galeria-provas');
            lista.innerHTML = '';
            const gravacoes = JSON.parse(localStorage.getItem('vigilancia_vids') || '[]');
            
            gravacoes.reverse().forEach(vid => {
                const item = document.createElement('div');
                item.className = 'prova-item';
                item.innerHTML = `
                    <video src="${vid.url}" controls></video>
                    <br>${vid.de} - ${new Date(vid.time).toLocaleTimeString()}
                `;
                lista.appendChild(item);
            });
        }

        function limparGravacoesAntigas() {
            const agora = Date.now();
            const vinteQuatroHoras = 24 * 60 * 60 * 1000;
            let gravacoes = JSON.parse(localStorage.getItem('vigilancia_vids') || '[]');
            
            // Filtra apenas o que tem menos de 24 horas
            gravacoes = gravacoes.filter(vid => (agora - vid.time) < vinteQuatroHoras);
            
            localStorage.setItem('vigilancia_vids', JSON.stringify(gravacoes));
            renderizarGaleria();
        }
    </script>
</body>
</html>
