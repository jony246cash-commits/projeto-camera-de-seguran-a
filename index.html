<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #000; color: #fff; text-align: center; overscroll-behavior: none; }
        .status-badge { padding: 15px; background: #1a1a1a; font-size: 14px; border-bottom: 1px solid #333; }
        #video-container { width: 100%; max-width: 640px; margin: auto; background: #000; }
        video { width: 100%; height: auto; border-radius: 0 0 10px 10px; }
        .menu { padding: 40px 20px; }
        button { width: 80%; max-width: 300px; padding: 18px; margin: 10px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-cam { background: #059669; color: white; }
        .btn-mon { background: #2563eb; color: white; }
        #app-camera, #app-monitor { display: none; }
        .alerta { background: #ef4444 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="status" class="status-badge">Carregando Sistema...</div>

    <div id="menu-inicial" class="menu">
        <h1>üõ°Ô∏è Smart Guard</h1>
        <p>Aguarde o status ficar "Pronto" antes de clicar.</p>
        <button id="btnIniciarCamera" class="btn-cam">MODO C√ÇMERA</button>
        <button id="btnIniciarMonitor" class="btn-mon">MODO MONITOR</button>
    </div>

    <div id="app-camera">
        <div id="video-container">
            <video id="webcam" autoplay muted playsinline></video>
        </div>
        <p>Sua c√¢mera est√° ativa e protegendo o local.</p>
    </div>

    <div id="app-monitor" style="padding: 20px;">
        <div id="alerta-video" style="display:none;">
            <h2 class="alerta" style="padding:10px; border-radius:8px;">üî¥ MOVIMENTO DETECTADO</h2>
            <video id="remote-video" autoplay playsinline style="width:100%;"></video>
        </div>
        <input type="text" id="id-destino" placeholder="ID da C√¢mera" style="padding:15px; width:80%; border-radius:8px; margin-bottom:10px;">
        <button id="btnConectar" class="btn-mon">CONECTAR AGORA</button>
    </div>

    <script>
        let model, peer, localStream, mediaRecorder;
        let conexoes = [];

        // Inicializa√ß√£o Segura
        window.addEventListener('load', () => {
            document.getElementById('status').innerText = "‚úÖ Sistema Pronto";
            
            // Configura os bot√µes via c√≥digo (evita erro de 'not defined')
            document.getElementById('btnIniciarCamera').addEventListener('click', iniciarCamera);
            document.getElementById('btnIniciarMonitor').addEventListener('click', iniciarMonitor);
            document.getElementById('btnConectar').addEventListener('click', conectarAoPeer);
        });

        async function iniciarCamera() {
            const id = prompt("Defina um ID para esta c√¢mera:");
            if (!id) return;

            try {
                document.getElementById('status').innerText = "Acessando C√¢mera...";
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                
                document.getElementById('webcam').srcObject = localStream;
                document.getElementById('menu-inicial').style.display = 'none';
                document.getElementById('app-camera').style.display = 'block';

                peer = new Peer(id);
                peer.on('open', () => {
                    document.getElementById('status').innerText = "C√¢mera Online: " + id;
                });

                peer.on('connection', conn => {
                    conexoes.push(conn);
                    document.getElementById('status').innerText = "Conectado ao Monitor";
                });

                // Iniciar IA de forma leve
                model = await cocoSsd.load({ base: 'mobilenet_v1' });
                detectar();
            } catch (e) {
                alert("Erro: Use HTTPS e autorize a c√¢mera. " + e.message);
            }
        }

        function iniciarMonitor() {
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('app-monitor').style.display = 'block';
            peer = new Peer();
            
            peer.on('open', id => {
                document.getElementById('status').innerText = "Monitor Online";
            });

            peer.on('call', call => {
                call.answer();
                document.getElementById('alerta-video').style.display = 'block';
                call.on('stream', st => {
                    document.getElementById('remote-video').srcObject = st;
                });
            });
        }

        function conectarAoPeer() {
            const targetId = document.getElementById('id-destino').value;
            const conn = peer.connect(targetId);
            conn.on('open', () => {
                alert("Conectado com sucesso!");
                conn.on('data', data => {
                    if(data === 'stop') document.getElementById('alerta-video').style.display = 'none';
                });
            });
        }

        async function detectar() {
            if (!model) return;
            const predictions = await model.detect(document.getElementById('webcam'));
            const person = predictions.some(p => p.class === 'person' && p.score > 0.6);

            if (person) {
                document.getElementById('status').classList.add('alerta');
                document.getElementById('status').innerText = "‚ö†Ô∏è PESSOA DETECTADA";
                conexoes.forEach(c => peer.call(c.peer, localStream));
            } else {
                document.getElementById('status').classList.remove('alerta');
                document.getElementById('status').innerText = "Monitorando...";
                conexoes.forEach(c => c.send('stop'));
            }
            requestAnimationFrame(detectar);
        }
    </script>
</body>
</html>
