<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Guard AI - Live Video & Record</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #0f0f0f; color: white; text-align: center; }
        .status-badge { padding: 12px; font-size: 14px; background: #222; border-bottom: 2px solid #444; sticky: top; z-index: 100; }
        .detected { background: #b91c1c; animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.7; } }

        #video-container { position: relative; width: 100%; max-width: 640px; margin: 10px auto; background: #000; border-radius: 8px; overflow: hidden; }
        video { width: 100%; display: block; }
        
        #monitor-ao-vivo { display: none; background: #1a1a1a; padding: 10px; border: 2px solid #b91c1c; margin: 10px; border-radius: 8px; }
        
        .controls { padding: 15px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-main { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        button:hover { opacity: 0.8; transform: scale(1.05); }

        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .card-item { background: #262626; border-radius: 8px; overflow: hidden; font-size: 12px; border: 1px solid #444; }
        .card-item video, .card-item img { width: 100%; height: auto; }

        #modo-selecao { padding: 60px 20px; }
        #config-monitor { display: none; padding: 20px; }
        input { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #1f2937; color: white; width: 260px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="status" class="status-badge">Aguardando Inicializa√ß√£o...</div>

    <div id="modo-selecao">
        <h1>üõ°Ô∏è Smart Guard Pro</h1>
        <p>Transforme seu dispositivo em uma sentinela inteligente.</p>
        <button class="btn-main" onclick="iniciarModoCamera()">MODO C√ÇMERA</button>
        <button class="btn-main" onclick="iniciarModoMonitor()">MODO MONITOR</button>
    </div>

    <div id="app-camera" style="display: none;">
        <div id="video-container">
            <video id="webcam" autoplay muted playsinline></video>
        </div>
        <div class="controls">
            <button class="btn-main" onclick="carregarGaleria()">Ver Grava√ß√µes</button>
            <button class="btn-danger" onclick="limparBanco()">Limpar Mem√≥ria</button>
        </div>
        <div id="galeria-local" class="galeria"></div>
    </div>

    <div id="config-monitor">
        <div id="monitor-ao-vivo">
            <h3 style="color: #ef4444; margin-top: 0;">üî¥ ALERTA: MOVIMENTO AO VIVO</h3>
            <video id="remote-video" autoplay playsinline></video>
        </div>
        
        <h3>Painel de Controle</h3>
        <input type="text" id="camera-id-input" placeholder="Digite o ID da C√¢mera Remota">
        <button class="btn-main" onclick="conectarCamera()">CONECTAR √Ä C√ÇMERA</button>
        <div id="info-conexao" style="margin-top: 15px; color: #10b981;"></div>
        <hr style="border-color: #333; margin: 20px 0;">
        <h4>Hist√≥rico de Alertas</h4>
        <div id="galeria-monitor" class="galeria"></div>
    </div>

    <script>
        const videoLocal = document.getElementById('webcam');
        const statusMsg = document.getElementById('status');
        let db, model, peer, mediaRecorder;
        let chunks = [];
        let gravando = false;
        let conexoesMonitores = [];
        let chamadasAtivas = [];

        // --- INICIALIZA√á√ÉO DB ---
        const request = indexedDB.open("SmartGuardDB", 1);
        request.onupgradeneeded = e => {
            e.target.result.createObjectStore("midia", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => { db = e.target.result; };

        // --- MODO C√ÇMERA ---
        async function iniciarModoCamera() {
            const cid = prompt("Crie um ID para esta c√¢mera:");
            if (!cid) return;

            document.getElementById('modo-selecao').style.display = 'none';
            document.getElementById('app-camera').style.display = 'block';

            peer = new Peer(cid);
            peer.on('open', id => {
                statusMsg.innerText = `C√ÇMERA ATIVA | ID: ${id}`;
                statusMsg.style.color = "#10b981";
            });

            peer.on('connection', conn => {
                conexoesMonitores.push(conn);
                statusMsg.innerText = `C√¢mera Online | Monitores: ${conexoesMonitores.length}`;
            });

            await iniciarIA();
        }

        async function iniciarIA() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                videoLocal.srcObject = stream;
                statusMsg.innerText = "Carregando Intelig√™ncia Artificial...";
                model = await cocoSsd.load();
                statusMsg.innerText = "Prote√ß√£o Ativa - Monitorando Ambiente";
                loopDeteccao();
            } catch (err) {
                statusMsg.innerText = "Erro no hardware: " +
