<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Lite - Transmiss√£o Direta</title>
    
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #0a0a0a; color: #fff; text-align: center; }
        .status-badge { padding: 12px; background: #111; font-size: 13px; border-bottom: 2px solid #333; color: #3b82f6; }
        .painel { padding: 30px 20px; }
        button { width: 85%; max-width: 300px; padding: 18px; margin: 8px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-cam { background: #059669; color: white; }
        .btn-mon { background: #2563eb; color: white; }
        
        .camera-card { background: #1a1a1a; margin: 15px auto; padding: 15px; width: 90%; max-width: 450px; border-radius: 12px; border: 1px solid #333; text-align: left; }
        .video-wrapper { width: 100%; border-radius: 8px; overflow: hidden; background: #000; margin-top: 10px; }
        video { width: 100%; display: block; }

        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 15px; }
        .prova-item { background: #222; padding: 8px; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>

    <div id="status" class="status-badge">üîµ Sistema de Transmiss√£o Pronto</div>

    <div id="menu-inicial" class="painel">
        <h1>üõ°Ô∏è Smart Guard Lite</h1>
        <p>Transmiss√£o Cont√≠nua & Grava√ß√£o 24h</p>
        <button id="btnCam" class="btn-cam">MODO C√ÇMERA (Transmitir)</button><br>
        <button id="btnMon" class="btn-mon">MODO MONITOR (Visualizar)</button>
    </div>

    <div id="tela-camera" style="display:none;">
        <h3 id="cam-id-txt">C√¢mera Ativa</h3>
        <video id="webcam" autoplay muted playsinline style="width: 80%; border-radius: 10px;"></video>
        <p>üì° Transmitindo e gravando em blocos de 2 min...</p>
    </div>

    <div id="tela-monitor" style="display:none;">
        <h3>Central de Monitoramento</h3>
        <input type="text" id="id-nova-camera" placeholder="ID da C√¢mera" style="padding:12px; border-radius:8px; border:none; width:150px;">
        <button id="btnAdd" style="width:auto; padding:12px;" class="btn-mon">VER</button>
        
        <div id="lista-cameras"></div>
        
        <h4>üé• Grava√ß√µes Recentes (Auto-limpeza 24h)</h4>
        <div id="galeria-provas" class="galeria"></div>
    </div>

    <script>
let peer, localStream, mediaRecorder;
let chunks = [];
let conexoes = {};
const TEMPO_GRAVACAO = 120000; // 2 minutos

// --- INICIALIZA√á√ÉO E BANCO DE DADOS (IndexedDB para v√≠deos grandes) ---
const dbRequest = indexedDB.open("VigilanciaDB", 1);
let db;

dbRequest.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("videos", { keyPath: "id", autoIncrement: true });
};
dbRequest.onsuccess = e => db = e.target.result;

window.onload = () => {
    document.getElementById('btnCam').onclick = modoCamera;
    document.getElementById('btnMon').onclick = modoMonitor;
};

// --- L√ìGICA DA C√ÇMERA ---
async function modoCamera() {
    const id = prompt("Nome desta c√¢mera:");
    if (!id) return;

    try {
        // Reduzindo a resolu√ß√£o para garantir que a transmiss√£o seja leve
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480, facingMode: "environment" }, 
            audio: true 
        });
        
        const videoLocal = document.getElementById('webcam');
        videoLocal.srcObject = localStream;
        videoLocal.onloadedmetadata = () => videoLocal.play(); // For√ßa o play

        document.getElementById('menu-inicial').style.display = 'none';
        document.getElementById('tela-camera').style.display = 'block';

        peer = new Peer(id, { config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });
        
        peer.on('connection', conn => {
            conexoes[conn.peer] = conn;
            console.log("Monitor conectado:", conn.peer);
            // Liga para o monitor para enviar o v√≠deo
            setTimeout(() => peer.call(conn.peer, localStream), 1000);
        });

        iniciarLoopGravacao();
    } catch (err) {
        alert("Erro na C√¢mera: " + err.message);
    }
}

function iniciarLoopGravacao() {
    mediaRecorder = new MediaRecorder(localStream, { mimeType: 'video/webm;codecs=vp8' });
    chunks = [];
    
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            Object.values(conexoes).forEach(conn => {
                conn.send({ tipo: 'arquivo', data: reader.result, de: peer.id, time: Date.now() });
            });
        };
        iniciarLoopGravacao(); // Reinicia o ciclo
    };
    
    mediaRecorder.start();
    setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, TEMPO_GRAVACAO);
}

// --- L√ìGICA DO MONITOR ---
function modoMonitor() {
    document.getElementById('menu-inicial').style.display = 'none';
    document.getElementById('tela-monitor').style.display = 'block';
    peer = new Peer();

    document.getElementById('btnAdd').onclick = () => {
        const id = document.getElementById('id-nova-camera').value;
        if(!id) return;
        
        if (!document.getElementById('card-'+id)) criarCard(id);
        const conn = peer.connect(id);
        
        conn.on('open', () => {
            conexoes[id] = conn;
            document.getElementById('status').innerText = "‚úÖ Conectado √† " + id;
        });

        conn.on('data', msg => {
            if (msg.tipo === 'arquivo') salvarNoBanco(msg);
        });
    };

    peer.on('call', call => {
        call.answer();
        call.on('stream', st => {
            const vid = document.querySelector(`#vid-${call.peer}`);
            if (vid) {
                vid.srcObject = st;
                vid.play().catch(e => console.log("Aguardando intera√ß√£o para √°udio"));
            }
        });
    });
    
    carregarGaleria();
}

function criarCard(id) {
    const div = document.createElement('div');
    div.id = 'card-'+id;
    div.className = 'camera-card';
    div.innerHTML = `
        <b>üìç ${id}</b> (Ao Vivo)
        <div class="video-wrapper">
            <video id="vid-${id}" autoplay muted playsinline style="background:black;"></video>
        </div>
    `;
    document.getElementById('lista-cameras').appendChild(div);
}

function salvarNoBanco(msg) {
    const transaction = db.transaction(["videos"], "readwrite");
    const store = transaction.objectStore("videos");
    store.add({ data: msg.data, de: msg.de, time: msg.time });
    transaction.oncomplete = () => carregarGaleria();
}

function carregarGaleria() {
    if(!db) return;
    const lista = document.getElementById('galeria-provas');
    lista.innerHTML = '';
    
    const store = db.transaction("videos").objectStore("videos");
    store.openCursor(null, 'prev').onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
            const vid = cursor.value;
            // Limpeza 24h: Se for mais velho que 24h, deleta e pula
            if (Date.now() - vid.time > 86400000) {
                db.transaction(["videos"], "readwrite").objectStore("videos").delete(cursor.key);
            } else {
                const item = document.createElement('div');
                item.className = 'prova-item';
                item.innerHTML = `
                    <video src="${vid.data}" controls style="width:100%"></video>
                    <br>${vid.de} - ${new Date(vid.time).toLocaleTimeString()}
                `;
                lista.appendChild(item);
            }
            cursor.continue();
        }
    };
        }
    </script>
</body>
</html>

