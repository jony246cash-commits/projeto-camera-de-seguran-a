<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Pro - Multi-Monitor</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #0a0a0a; color: #fff; text-align: center; }
        .status-badge { padding: 12px; background: #1a1a1a; font-size: 13px; border-bottom: 2px solid #333; color: #10b981; }
        
        /* Menu e Bot√µes */
        .painel { padding: 30px 20px; }
        button { width: 85%; max-width: 300px; padding: 18px; margin: 8px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-cam { background: #059669; color: white; }
        .btn-mon { background: #2563eb; color: white; }
        
        /* Estilo Monitor Multi-C√¢mera */
        .camera-card { background: #1a1a1a; margin: 10px auto; padding: 15px; width: 90%; border-radius: 12px; border: 1px solid #333; text-align: left; }
        .camera-card.alert { border-color: #ef4444; background: #2d0a0a; }
        .cam-name { font-weight: bold; color: #60a5fa; }
        
        /* Players de V√≠deo */
        .video-wrapper { width: 100%; max-width: 500px; margin: 10px auto; display: none; border-radius: 8px; overflow: hidden; border: 2px solid #ef4444; }
        video { width: 100%; background: #000; }

        /* Galeria de Provas */
        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 15px; }
        .prova-item { background: #222; padding: 8px; border-radius: 8px; font-size: 11px; }
        .prova-item video { width: 100%; border-radius: 4px; }
        .btn-dl { color: #22d3ee; display: block; margin-top: 5px; text-decoration: none; border: 1px solid #22d3ee; padding: 3px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="status" class="status-badge">üü° Aguardando Inicializa√ß√£o...</div>

    <div id="menu-inicial" class="painel">
        <h1>üõ°Ô∏è Smart Guard Multi</h1>
        <button id="btnCam" class="btn-cam">MODO C√ÇMERA (Este aparelho filma)</button>
        <button id="btnMon" class="btn-mon">MODO MONITOR (Ver todas as c√¢meras)</button>
    </div>

    <div id="tela-camera" style="display:none;">
        <video id="webcam" autoplay muted playsinline></video>
        <p>Aparelho configurado como c√¢mera.</p>
    </div>

    <div id="tela-monitor" style="display:none; padding-bottom: 50px;">
        <h3>Central de Monitoramento</h3>
        
        <div style="background:#1a1a1a; padding:15px; margin:10px; border-radius:10px;">
            <input type="text" id="id-nova-camera" placeholder="ID da C√¢mera (ex: sala)" style="padding:12px; width:60%; border-radius:8px; border:none;">
            <button id="btnAdd" style="width:30%; padding:12px; margin:0; font-size:12px;" class="btn-mon">ADICIONAR</button>
        </div>

        <div id="lista-cameras">
            </div>

        <h4>üì¶ Provas Recebidas</h4>
        <div id="galeria-provas" class="galeria"></div>
    </div>

    <script>
        let peer, localStream, model, mediaRecorder;
        let chunks = [];
        let gravando = false;
        let conexoes = {}; // Armazena m√∫ltiplas conex√µes: { 'sala': conn, 'cozinha': conn }

        window.onload = () => {
            document.getElementById('status').innerText = "‚úÖ Pronto";
            document.getElementById('btnCam').onclick = modoCamera;
            document.getElementById('btnMon').onclick = modoMonitor;
            document.getElementById('btnAdd').onclick = conectarNovaCamera;
        };

        // --- L√ìGICA DO APARELHO QUE √â C√ÇMERA ---
        async function modoCamera() {
            const id = prompt("Nome desta c√¢mera (ex: sala, garagem):");
            if (!id) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                document.getElementById('webcam').srcObject = localStream;
                document.getElementById('menu-inicial').style.display = 'none';
                document.getElementById('tela-camera').style.display = 'block';

                peer = new Peer(id);
                peer.on('connection', conn => {
                    conexoes[conn.peer] = conn;
                    document.getElementById('status').innerText = "Conectado ao Monitor Central";
                });

                model = await cocoSsd.load({ base: 'mobilenet_v1' });
                loop();
            } catch (e) { alert("Erro: " + e.message); }
        }

        async function loop() {
            const pred = await model.detect(document.getElementById('webcam'));
            const invasor = pred.some(p => p.class === 'person' && p.score > 0.6);

            if (invasor && !gravando) {
                gravando = true; chunks = [];
                mediaRecorder = new MediaRecorder(localStream, { mimeType: 'video/webm' });
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = enviarProva;
                mediaRecorder.start();
                
                // Avisa todos os monitores e envia v√≠deo ao vivo
                Object.values(conexoes).forEach(c => {
                    c.send({ tipo: 'alerta', estado: 'on' });
                    peer.call(c.peer, localStream);
                });
            } else if (!invasor && gravando) {
                gravando = false;
                mediaRecorder.stop();
                Object.values(conexoes).forEach(c => c.send({ tipo: 'alerta', estado: 'off' }));
            }
            requestAnimationFrame(loop);
        }

        function enviarProva() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                Object.values(conexoes).forEach(c => {
                    c.send({ tipo: 'arquivo', data: reader.result, de: peer.id });
                });
            };
        }

        // --- L√ìGICA DO APARELHO QUE √â MONITOR ---
        function modoMonitor() {
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('tela-monitor').style.display = 'block';
            peer = new Peer();
            
            peer.on('call', call => {
                call.answer();
                const wrapper = document.getElementById('video-' + call.peer);
                if (wrapper) {
                    wrapper.style.display = 'block';
                    const vid = wrapper.querySelector('video');
                    call.on('stream', st => vid.srcObject = st);
                }
            });
        }

        function conectarNovaCamera() {
            const idCam = document.getElementById('id-nova-camera').value;
            if (!idCam || conexoes[idCam]) return;

            const conn = peer.connect(idCam);
            conn.on('open', () => {
                conexoes[idCam] = conn;
                document.getElementById('id-nova-camera').value = "";
                
                // Cria o card da c√¢mera na tela
                const div = document.createElement('div');
                div.id = 'card-' + idCam;
                div.className = 'camera-card';
                div.innerHTML = `
                    <span class="cam-name">üìç C√¢mera: ${idCam}</span> - <span id="st-${idCam}">Protegido</span>
                    <div id="video-${idCam}" class="video-wrapper"><video autoplay playsinline></video></div>
                `;
                document.getElementById('lista-cameras').appendChild(div);

                conn.on('data', msg => {
                    const card = document.getElementById('card-' + idCam);
                    const statusTxt = document.getElementById('st-' + idCam);
                    const wrapper = document.getElementById('video-' + idCam);

                    if (msg.tipo === 'alerta') {
                        if (msg.estado === 'on') {
                            card.classList.add('alert');
                            statusTxt.innerText = "‚ö†Ô∏è INVAS√ÉO DETECTADA!";
                        } else {
                            card.classList.remove('alert');
                            statusTxt.innerText = "Protegido";
                            wrapper.style.display = 'none';
                        }
                    }
                    if (msg.tipo === 'arquivo') {
                        adicionarProva(msg.data, msg.de);
                    }
                });
            });
        }

        function adicionarProva(url, nome) {
            const item = document.createElement('div');
            item.className = 'prova-item';
            item.innerHTML = `
                <video src="${url}" controls></video>
                <b>Origem: ${nome}</b><br>${new Date().toLocaleTimeString()}
                <a href="${url}" download="prova_${nome}.webm" class="btn-dl">BAIXAR</a>
            `;
            document.getElementById('galeria-provas').prepend(item);
        }
    </script>
</body>
</html>
