<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Pro - Prova de Invas√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; }
        .status-badge { padding: 15px; background: #1a1a1a; font-size: 14px; border-bottom: 2px solid #333; }
        .modo-alerta { background: #b91c1c !important; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
        
        #video-display { width: 100%; max-width: 600px; margin: auto; background: #000; }
        video { width: 100%; height: auto; }
        
        .painel { padding: 30px 20px; }
        button { width: 85%; max-width: 300px; padding: 20px; margin: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-cam { background: #059669; color: white; }
        .btn-mon { background: #2563eb; color: white; }
        
        #galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 20px; }
        .card-video { background: #222; padding: 5px; border-radius: 5px; border: 1px solid #444; }
        .card-video video { width: 100%; }
    </style>
</head>
<body>

    <div id="status" class="status-badge">üü° Carregando Intelig√™ncia...</div>

    <div id="menu-inicial" class="painel">
        <h1>üõ°Ô∏è Smart Guard</h1>
        <p>Sistema de Vigil√¢ncia com Grava√ß√£o de Provas</p>
        <button id="btnCam" class="btn-cam">MODO C√ÇMERA (Capturar Invasor)</button>
        <button id="btnMon" class="btn-mon">MODO MONITOR (Ver ao Vivo)</button>
    </div>

    <div id="tela-camera" style="display:none;">
        <div id="video-display">
            <video id="webcam" autoplay muted playsinline></video>
        </div>
        <div id="galeria"></div>
    </div>

    <div id="tela-monitor" style="display:none; padding: 20px;">
        <div id="alerta-live" style="display:none; border: 5px solid #ef4444; margin-bottom: 20px;">
            <h2 style="background:#ef4444; margin:0; padding:10px;">üî¥ INVASOR AO VIVO</h2>
            <video id="remote-video" autoplay playsinline></video>
        </div>
        <input type="text" id="id-camera" placeholder="Digite o ID da C√¢mera" style="padding:15px; width:80%; border-radius:8px;">
        <button id="btnConectar" class="btn-mon" style="margin-top:15px;">CONECTAR √Ä C√ÇMERA</button>
    </div>

    <script>
        let model, peer, localStream, mediaRecorder;
        let chunks = [];
        let gravando = false;
        let conexoesAtivas = [];

        window.onload = () => {
            document.getElementById('status').innerText = "‚úÖ Sistema Pronto";
            document.getElementById('btnCam').onclick = iniciarModoCamera;
            document.getElementById('btnMon').onclick = iniciarModoMonitor;
            document.getElementById('btnConectar').onclick = conectarMonitor;
        };

        async function iniciarModoCamera() {
            const id = prompt("Crie um ID para esta c√¢mera (ex: casa1):");
            if (!id) return;

            try {
                // 1. Acessa C√¢mera
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                document.getElementById('webcam').srcObject = localStream;
                document.getElementById('menu-inicial').style.display = 'none';
                document.getElementById('tela-camera').style.display = 'block';

                // 2. Inicia Peer para transmiss√£o
                peer = new Peer(id);
                peer.on('open', () => document.getElementById('status').innerText = "C√ÇMERA ATIVA: " + id);
                peer.on('connection', conn => conexoesAtivas.push(conn));

                // 3. Carrega IA Leve para Mobile
                document.getElementById('status').innerText = "‚öôÔ∏è Ativando IA...";
                model = await cocoSsd.load({ base: 'mobilenet_v1' });
                document.getElementById('status').innerText = "üõ°Ô∏è Monitoramento em Tempo Real";
                
                loopDeteccao();
            } catch (e) {
                alert("Erro: " + e.message);
            }
        }

        async function loopDeteccao() {
            if (!model) return;
            const predictions = await model.detect(document.getElementById('webcam'));
            const invasor = predictions.some(p => p.class === 'person' && p.score > 0.6);

            if (invasor) {
                document.getElementById('status').innerText = "‚ö†Ô∏è INVASOR DETECTADO!";
                document.getElementById('status').classList.add('modo-alerta');
                
                if (!gravando) {
                    come√ßarGravacaoETransmissao();
                }
            } else {
                if (gravando) {
                    pararGravacaoETransmissao();
                }
                document.getElementById('status').classList.remove('modo-alerta');
                document.getElementById('status').innerText = "Ambiente Seguro";
            }
            requestAnimationFrame(loopDeteccao);
        }

        function come√ßarGravacaoETransmissao() {
            gravando = true;
            chunks = [];
            
            // GRAVA√á√ÉO (PROVA)
            mediaRecorder = new MediaRecorder(localStream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = salvarVideoNaGaleria;
            mediaRecorder.start();

            // TRANSMISS√ÉO AO VIVO (MONITOR)
            conexoesAtivas.forEach(conn => {
                peer.call(conn.peer, localStream);
            });
        }

        function pararGravacaoETransmissao() {
            gravando = false;
            if (mediaRecorder) mediaRecorder.stop();
            conexoesAtivas.forEach(conn => conn.send('fechar_video'));
        }

        function salvarVideoNaGaleria() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const galeria = document.getElementById('galeria');
            
            const div = document.createElement('div');
            div.className = 'card-video';
            div.innerHTML = `
                <video src="${url}" controls></video>
                <a href="${url}" download="prova_${Date.now()}.webm" style="color:cyan; font-size:10px;">BAIXAR PROVA</a>
            `;
            galeria.prepend(div);
        }

        // --- L√ìGICA DO MONITOR ---
        function iniciarModoMonitor() {
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('tela-monitor').style.display = 'block';
            peer = new Peer();
            
            peer.on('call', call => {
                call.answer();
                document.getElementById('alerta-live').style.display = 'block';
                call.on('stream', st => {
                    document.getElementById('remote-video').srcObject = st;
                });
            });
        }

        function conectarMonitor() {
            const targetId = document.getElementById('id-camera').value;
            const conn = peer.connect(targetId);
            conn.on('open', () => {
                alert("Monitor Conectado √† C√¢mera!");
                conn.on('data', data => {
                    if (data === 'fechar_video') document.getElementById('alerta-live').style.display = 'none';
                });
            });
        }
    </script>
</body>
</html>
