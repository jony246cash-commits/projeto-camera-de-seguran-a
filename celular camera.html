<script>
let model, webcam, statusEl, galeriaEl;
const status = document.getElementById('status');
const video = document.getElementById('webcam');
const galeria = document.getElementById('galeria');

async function init() {
    status.textContent = 'Carregando modelo...';
    try {
        model = await cocoSsd.load(); // pode usar 'lite_mobilenet_v2' para mais rápido
        status.textContent = 'Acessando câmera...';
        
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }, // câmera traseira no celular
            audio: false
        });
        video.srcObject = stream;
        
        status.textContent = 'Online';
        status.classList.add('online');
        
        detectFrame(); // inicia loop de detecção
    } catch (e) {
        status.textContent = 'Erro: ' + e.message;
        status.classList.add('alert');
        console.error(e);
    }
}

async function detectFrame() {
    if (!model) return;
    
    const predictions = await model.detect(video);
    
    // Exemplo: se detectar pessoa, captura foto
    const pessoa = predictions.find(p => p.class === 'person' && p.score > 0.6);
    if (pessoa) {
        capturarFoto();
        status.textContent = 'ALERTA: Pessoa detectada!';
        status.classList.add('alert');
        setTimeout(() => {
            status.classList.remove('alert');
            status.textContent = 'Online';
        }, 3000);
    }
    
    requestAnimationFrame(detectFrame); // loop contínuo ~30fps
}

function capturarFoto() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    const dataURL = canvas.toDataURL('image/jpeg', 0.8);
    const timestamp = new Date().toLocaleString();
    
    // Salva no localStorage (máx ~5-10MB por domínio)
    let fotos = JSON.parse(localStorage.getItem('fotosSeguranca') || '[]');
    fotos.unshift({dataURL, timestamp}); // mais nova primeiro
    if (fotos.length > 50) fotos.pop(); // limita quantidade
    localStorage.setItem('fotosSeguranca', JSON.stringify(fotos));
    
    carregarGaleria();
}

function carregarGaleria() {
    galeria.innerHTML = '';
    const fotos = JSON.parse(localStorage.getItem('fotosSeguranca') || '[]');
    fotos.forEach(foto => {
        const card = document.createElement('div');
        card.className = 'card-foto';
        card.innerHTML = `
            <img src="${foto.dataURL}">
            <div>${foto.timestamp}</div>
        `;
        galeria.appendChild(card);
    });
}

function limparMemoria() {
    if (confirm('Tem certeza que quer apagar todas as fotos?')) {
        localStorage.removeItem('fotosSeguranca');
        carregarGaleria();
    }
}

// Inicia tudo quando página carrega
window.onload = () => {
    init();
    carregarGaleria();
};
</script>
